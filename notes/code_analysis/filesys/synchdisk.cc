// synchdisk.cc 
//	同步访问磁盘的例程。物理磁盘是异步设备
//	（磁盘请求立即返回，稍后发生中断）。
//	这是在磁盘之上的一个层，提供同步接口
//	（请求等待直到请求完成）。
//
//	使用信号量同步中断处理程序与待处理请求。
//	而且，因为物理磁盘一次只能处理一个操作，
//	使用锁来强制互斥。
//
// Copyright (c) 1992-1993 The Regents of the University of California.
// All rights reserved.  See copyright.h for copyright notice and limitation 
// of liability and disclaimer of warranty provisions.

#include "copyright.h"
#include "synchdisk.h"

// SynchDisk类设计说明：
// SynchDisk(同步磁盘)是一个同步原语层，封装了底层异步磁盘设备
// 主要解决两个问题：
// 1. 线程安全：使用锁确保一次只有一个磁盘操作
// 2. 同步访问：使用信号量等待磁盘操作完成
//
// 核心组件：
// - Disk: 物理磁盘设备(异步)
// - Lock: 互斥锁，确保独占访问
// - Semaphore: 同步信号量，等待操作完成
// 
// 工作流程：
// 1. 获取锁(确保独占访问)
// 2. 发送请求到物理磁盘
// 3. P操作等待完成信号
// 4. 释放锁
// 5. 中断处理程序执行V操作唤醒等待线程

//----------------------------------------------------------------------
// DiskRequestDone
// 	磁盘中断处理程序。需要这是一个 C 例程，因为
//	C++ 无法处理指向成员函数的指针。
//
//	实现逻辑：
//	1. 将传入参数转换为SynchDisk对象指针
//	2. 调用该对象的RequestDone方法
//
//	关键点：
//	- 这是静态C函数，不是类成员函数
//	- 通过void*参数传递SynchDisk对象指针
//	- 实际工作在SynchDisk::RequestDone中完成
//	- 用于处理物理磁盘操作完成中断
//----------------------------------------------------------------------

static void
DiskRequestDone (_int arg)		// 中断处理程序，当磁盘操作完成时被调用
{
    SynchDisk* dsk = (SynchDisk *)arg;	// 将参数转换为SynchDisk对象指针

    dsk->RequestDone();			// 调用对象的完成处理方法
}

//----------------------------------------------------------------------
// SynchDisk::SynchDisk
// 	初始化与物理磁盘的同步接口，依次初始化物理磁盘。
//
//	"name" -- 用作磁盘数据存储的 UNIX 文件名
//	   （通常，"DISK"）
//
//	实现逻辑：
//	1. 创建同步信号量(初始值为0)
//	2. 创建互斥锁
//	3. 创建物理磁盘对象，注册中断处理程序
//
//	参数：
//	- name: 磁盘文件名，通常是"DISK"
//
//	关键点：
//	- 信号量初始值为0，因为还没有完成的请求
//	- 锁名称用于调试目的
//	- 传递this指针给物理磁盘，用于中断时回调
//----------------------------------------------------------------------

SynchDisk::SynchDisk(const char* name)
{
    // 创建同步信号量，初始值为0，表示无完成的请求
    semaphore = new Semaphore("synch disk", 0);
    
    // 创建互斥锁，确保磁盘访问的排他性
    lock = new Lock("synch disk lock");
    
    // 创建物理磁盘对象
    // 参数：磁盘文件名，中断处理函数，传递给中断函数的参数(this指针)
    disk = new Disk(name, DiskRequestDone, (_int) this);
}

//----------------------------------------------------------------------
// SynchDisk::~SynchDisk
// 	释放同步磁盘抽象所需的数据结构。
//
//	实现逻辑：
//	按照与构造相反的顺序释放资源
//	1. 释放物理磁盘对象
//	2. 释放互斥锁
//	3. 释放信号量
//
//	关键点：
//	- 遵循RAII原则，确保资源正确释放
//	- 释放顺序与创建顺序相反
//	- 防止资源泄漏
//----------------------------------------------------------------------

SynchDisk::~SynchDisk()
{
    delete disk;		// 释放物理磁盘对象
    delete lock;		// 释放互斥锁
    delete semaphore;		// 释放同步信号量
}

//----------------------------------------------------------------------
// SynchDisk::ReadSector
// 	将磁盘扇区的内容读入缓冲区。仅在数据被读取后才返回。
//
//	"sectorNumber" -- 要读取的磁盘扇区
//	"data" -- 保存磁盘扇区内容的缓冲区
//
//	实现逻辑：
//	1. 获取互斥锁，确保独占访问磁盘
//	2. 向物理磁盘发送读取请求
//	3. P操作等待信号量(等待中断)
//	4. 释放互斥锁
//
//	参数：
//	- sectorNumber: 要读取的扇区号
//	- data: 存储读取数据的缓冲区
//
//	关键点：
//	- 使用锁确保一次只有一个磁盘操作
//	- 使用信号量实现同步等待
//	- 操作完成后中断处理程序会发出信号
//	- 线程安全的磁盘访问
//----------------------------------------------------------------------

void
SynchDisk::ReadSector(int sectorNumber, char* data)
{
    lock->Acquire();			// 获取锁，确保独占访问磁盘
    disk->ReadRequest(sectorNumber, data);  // 向物理磁盘发送读取请求
    semaphore->P();			// P操作等待，直到中断处理程序发出完成信号
    lock->Release();			// 释放锁，允许其他线程访问磁盘
}

//----------------------------------------------------------------------
// SynchDisk::WriteSector
// 	将缓冲区的内容写入磁盘扇区。仅在数据被写入后才返回。
//
//	"sectorNumber" -- 要写入的磁盘扇区
//	"data" -- 磁盘扇区的新内容
//
//	实现逻辑：
//	1. 获取互斥锁，确保独占访问磁盘
//	2. 向物理磁盘发送写入请求
//	3. P操作等待信号量(等待中断)
//	4. 释放互斥锁
//
//	参数：
//	- sectorNumber: 要写入的扇区号
//	- data: 要写入的数据
//
//	关键点：
//	- 与ReadSector使用相同的同步机制
//	- 确保写操作的原子性
//	- 线程安全的磁盘写入
//----------------------------------------------------------------------

void
SynchDisk::WriteSector(int sectorNumber, char* data)
{
    lock->Acquire();			// 获取锁，确保独占访问磁盘
    disk->WriteRequest(sectorNumber, data);  // 向物理磁盘发送写入请求
    semaphore->P();			// P操作等待，直到中断处理程序发出完成信号
    lock->Release();			// 释放锁，允许其他线程访问磁盘
}

//----------------------------------------------------------------------
// SynchDisk::RequestDone
// 	磁盘中断处理程序。唤醒任何等待磁盘请求完成的线程。
//
//	实现逻辑：
//	执行信号量的V操作，唤醒等待的线程
//
//	关键点：
//	- 由物理磁盘中断时调用
//	- 使用V操作释放信号量
//	- 唤醒在semaphore->P()处等待的线程
//	- 实现了异步操作的同步接口
//
//	使用场景：
//	- 物理磁盘完成读取操作时
//	- 物理磁盘完成写入操作时
//	- 通知等待线程操作已完成
//----------------------------------------------------------------------

void
SynchDisk::RequestDone()
{ 
    // 执行V操作，释放信号量，唤醒在P操作处等待的线程
    semaphore->V();
}